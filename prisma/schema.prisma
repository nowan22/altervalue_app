generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/altervalue/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  role          Role      @default(PILOTE_QVCT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  companies     Company[]
  // v4.0: Activity logs created by this user
  activityLogs  ActivityLog[]
  // v4.0-epsilon: Mission assignments for Pilotes/Observateurs
  missionAssignments MissionAssignment[]
}

// v4.0: User roles for RBAC
enum Role {
  SUPER_ADMIN     // AlterValue team - full platform access
  EXPERT          // Consultant - manages client portfolio
  PILOTE_QVCT     // Client - action role (edit/manage)
  OBSERVATEUR     // Client - read-only (CSE, COMEX)
}

model Company {
  id                      String    @id @default(cuid())
  name                    String
  sector                  String
  country                 String    @default("France")
  employeesCount          Int
  avgGrossSalary          Float
  employerContributionRate Float
  absenteeismRate         Float
  hoursPerYear            Int       @default(1600)
  annualValueAdded        Float?    // Optional: annual value added or revenue
  // v3.1: Company details for document templates
  siret                   String?
  address                 String?
  directorName            String?
  directorTitle           String?   @default("Directeur général")
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  userId                  String
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  kpis                    KpiSnapshot[]
  isDemo                  Boolean   @default(false)
  // BNQ Module relations
  documents               Document[]
  workflowSteps           WorkflowStep[]
  checklistItems          BnqChecklistItem[]
  bnqProgress             CompanyBnqProgress?
  // BNQ v3.0 - Plan d'action & Alertes
  actionPlans             ActionPlan[]
  alerts                  BnqAlert[]
  alertConfigs            AlertConfig[]
  // Survey Module relations (Method B - Legacy)
  surveys                 Survey[]
  // v4.1: Survey Engine campaigns
  surveyCampaigns         SurveyCampaign[]
  // v4.0-epsilon: Mission assignments for Pilotes/Observateurs
  missionAssignments      MissionAssignment[]
}

// v4.0-epsilon: Assignment table for linking missions to Pilotes/Observateurs
model MissionAssignment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedAt  DateTime @default(now())
  assignedBy  String?  // ID of user who made the assignment
  
  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

model KpiSnapshot {
  id                      String    @id @default(cuid())
  companyId               String
  company                 Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  periodDate              DateTime
  periodType              String    @default("MONTHLY")  // MONTHLY or QUARTERLY
  // KPI data
  employeesCount          Int?
  avgGrossSalary          Float?
  employerContributionRate Float?
  absenteeismRate         Float?
  turnoverRate            Float?
  avgSeniorityYears       Float?
  atMpGravityRate         Float?
  engagementScore         Float?
  // Calculated presenteeism values
  presRateCalculated      Float?
  presDaysCalculated      Float?
  productivityLoss        Float?
  presCostCalculated      Float?
  presCostPerEmployee     Float?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@index([companyId, periodDate])
}

model Settings {
  id                        String    @id @default(cuid())
  // Coefficient values
  presAbsCoefficient        Float     @default(1.3)
  productivityLossCoeff     Float     @default(0.33)
  workingDaysPerYear        Int       @default(220)
  // Color thresholds for signals
  absenteeismGreenMax       Float     @default(4.0)
  absenteeismOrangeMax      Float     @default(6.0)
  turnoverGreenMax          Float     @default(10.0)
  turnoverOrangeMax         Float     @default(15.0)
  presCostGreenMaxPct       Float     @default(5.0)
  presCostOrangeMaxPct      Float     @default(8.0)
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
}

model SectorBenchmark {
  id                    String    @id @default(cuid())
  sector                String    @unique
  absenteeismAvg        Float
  absenteeismMin        Float
  absenteeismMax        Float
  turnoverAvg           Float
  turnoverMin           Float
  turnoverMax           Float
  avgSeniorityYears     Float
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// ==================== BNQ 9700-800 MODULE ====================

enum BnqLevel {
  ES      // Entreprise en santé (Basic)
  ESE     // Entreprise en santé - Élite
  ESE_PLUS // Entreprise en santé - Élite plus
}

enum DocumentStatus {
  DRAFT
  PENDING_VALIDATION
  APPROVED
  ARCHIVED
  EXPIRED
}

enum DocumentCategory {
  ENGAGEMENT_DIRECTION
  POLITIQUE_GOUVERNANCE
  SST_RISQUES
  MESURES_RH
  CONFIDENTIALITE
  COLLECTE_RAPPORTS
}

// Document types required for BNQ certification
model DocumentType {
  id                  String            @id @default(cuid())
  code                String            @unique
  name                String
  description         String?
  category            DocumentCategory
  bnqArticle          String?           // e.g., "Art. 5.1"
  requiredForLevel    BnqLevel          @default(ES)
  isOptional          Boolean           @default(false)
  revisionFrequency   String?           // e.g., "3 years", "annual", "continuous"
  templateUrl         String?
  sortOrder           Int               @default(0)
  documents           Document[]
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

// Actual documents uploaded by companies
model Document {
  id                  String            @id @default(cuid())
  companyId           String
  company             Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documentTypeId      String
  documentType        DocumentType      @relation(fields: [documentTypeId], references: [id])
  fileName            String
  fileUrl             String?
  cloudStoragePath    String?
  version             Int               @default(1)
  status              DocumentStatus    @default(DRAFT)
  validatedBy         String?
  validatedAt         DateTime?
  validationSignature String?
  expiresAt           DateTime?
  notes               String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([companyId, documentTypeId])
}

// Workflow steps for management adherence
enum WorkflowStepStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

model WorkflowStep {
  id                  String              @id @default(cuid())
  companyId           String
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stepNumber          Int
  stepCode            String              // e.g., "ENGAGEMENT_INITIAL", "POLITIQUE_SME"
  stepName            String
  description         String?
  status              WorkflowStepStatus  @default(NOT_STARTED)
  completedBy         String?
  completedAt         DateTime?
  signature           String?
  signatureTimestamp  DateTime?
  notes               String?
  dueDate             DateTime?
  tasks               WorkflowTask[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@unique([companyId, stepNumber])
  @@index([companyId])
}

model WorkflowTask {
  id                  String              @id @default(cuid())
  workflowStepId      String
  workflowStep        WorkflowStep        @relation(fields: [workflowStepId], references: [id], onDelete: Cascade)
  taskCode            String
  taskName            String
  isRequired          Boolean             @default(true)
  isCompleted         Boolean             @default(false)
  completedAt         DateTime?
  completedBy         String?
  notes               String?
  sortOrder           Int                 @default(0)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([workflowStepId])
}

// BNQ Checklist items
model BnqChecklistItem {
  id                  String              @id @default(cuid())
  companyId           String
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  chapter             Int                 // BNQ chapter (5-9)
  articleRef          String              // e.g., "5.1", "7.4.5.e"
  requirement         String
  requiredForLevel    BnqLevel            @default(ES)
  isCompliant         Boolean?            // null = not evaluated, true = compliant, false = non-compliant
  evaluatedAt         DateTime?
  evaluatedBy         String?
  evidence            String?             // Description of evidence
  documentId          String?             // Link to uploaded document
  notes               String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([companyId, chapter])
}

// Company BNQ Progress tracking
model CompanyBnqProgress {
  id                  String              @id @default(cuid())
  companyId           String              @unique
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  targetLevel         BnqLevel            @default(ES)
  currentProgress     Float               @default(0)  // 0-100%
  documentsProgress   Float               @default(0)
  checklistProgress   Float               @default(0)
  workflowProgress    Float               @default(0)
  actionsProgress     Float               @default(0)  // v3.0: Plan d'action progress
  lastEvaluatedAt     DateTime?
  certificationDate   DateTime?
  certificationExpiry DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

// =====================================================
// BNQ v3.0 - PLAN D'ACTION & INTERVENTIONS
// =====================================================

// 4 Spheres of activity (BNQ Art. 7.4.1)
enum ActivitySphere {
  HABITUDES_VIE           // Lifestyle habits
  CONCILIATION_TRAVAIL    // Work-life balance
  ENVIRONNEMENT_TRAVAIL   // Work environment
  PRATIQUES_GESTION       // Management practices
}

// Intervention status
enum InterventionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

// Priority levels
enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Annual Action Plan
model ActionPlan {
  id                  String              @id @default(cuid())
  companyId           String
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  year                Int                 // e.g., 2026
  title               String              @default("Plan d'action santé mieux-être")
  description         String?
  status              String              @default("DRAFT")  // DRAFT, ACTIVE, COMPLETED, ARCHIVED
  targetLevel         BnqLevel            @default(ES)
  // Minimum requirements tracking (depends on level)
  minInterventions    Int                 @default(2)   // [Es]: 2, [EsE]: 4, [EsE+]: 6
  minPriorities       Int                 @default(1)   // [Es]: 1, [EsE]: 2, [EsE+]: 3
  minPratiquesGestion Int                 @default(0)   // [Es]: 0, [EsE]: 1, [EsE+]: 2
  // Approval tracking
  approvedBy          String?
  approvedAt          DateTime?
  // Relations
  interventions       Intervention[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@unique([companyId, year])
  @@index([companyId])
}

// Individual interventions within an action plan
model Intervention {
  id                  String              @id @default(cuid())
  actionPlanId        String
  actionPlan          ActionPlan          @relation(fields: [actionPlanId], references: [id], onDelete: Cascade)
  // Basic info
  title               String
  description         String?
  sphere              ActivitySphere
  priority            Priority            @default(MEDIUM)
  status              InterventionStatus  @default(PLANNED)
  // BNQ alignment
  addressesPriority   Boolean             @default(false)  // Addresses identified priority need
  bnqArticleRef       String?             // e.g., "7.4.1.a"
  // Planning
  responsiblePerson   String?             // Name of responsible person
  responsibleRole     String?             // Role/function
  startDate           DateTime?
  targetEndDate       DateTime?
  actualEndDate       DateTime?
  budget              Float?              // Estimated budget
  actualCost          Float?              // Actual cost
  // Evaluation metrics (BNQ Art. 9)
  targetParticipation Float?              // Target % of employees
  actualParticipation Float?              // Actual % participation
  satisfactionScore   Float?              // Satisfaction score (0-10)
  expectedOutcome     String?             // Expected measurable outcome
  actualOutcome       String?             // Actual outcome achieved
  // Progress
  progressNotes       String?
  completedAt         DateTime?
  completedBy         String?
  // Relations
  alerts              BnqAlert[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([actionPlanId])
  @@index([sphere])
}

// =====================================================
// BNQ v3.0 - ALERTES & RAPPELS
// =====================================================

enum AlertType {
  DOCUMENT_EXPIRY           // Document about to expire
  DOCUMENT_MISSING          // Required document missing
  DOCUMENT_REVISION         // Document needs revision (3 years)
  WORKFLOW_OVERDUE          // Workflow step overdue
  INTERVENTION_DEADLINE     // Intervention deadline approaching
  INTERVENTION_OVERDUE      // Intervention past due
  DATA_COLLECTION           // Time for data collection (2-3 years)
  ANNUAL_REVIEW             // Annual review reminder
  CERTIFICATION_EXPIRY      // Certification expiring
  DUERP_UPDATE              // DUERP annual update required
  COMMITTEE_MEETING         // Minimum 4 meetings/year
  CUSTOM                    // Custom reminder
}

enum AlertSeverity {
  INFO
  WARNING
  URGENT
  CRITICAL
}

model BnqAlert {
  id                  String              @id @default(cuid())
  companyId           String
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  type                AlertType
  severity            AlertSeverity       @default(WARNING)
  title               String
  message             String
  // Related entities (optional)
  documentId          String?
  workflowStepId      String?
  interventionId      String?
  intervention        Intervention?       @relation(fields: [interventionId], references: [id], onDelete: SetNull)
  // Scheduling
  triggerDate         DateTime            // When the alert becomes active
  dueDate             DateTime?           // Deadline for the alert
  // Status
  isRead              Boolean             @default(false)
  readAt              DateTime?
  isDismissed         Boolean             @default(false)
  dismissedAt         DateTime?
  dismissedBy         String?
  isResolved          Boolean             @default(false)
  resolvedAt          DateTime?
  resolvedBy          String?
  // Recurrence
  isRecurring         Boolean             @default(false)
  recurrencePattern   String?             // "ANNUAL", "QUARTERLY", "MONTHLY"
  nextOccurrence      DateTime?
  // Email notification
  emailSent           Boolean             @default(false)
  emailSentAt         DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([companyId, isResolved])
  @@index([triggerDate])
}

// v4.0-theta: Alert configuration per company
model AlertConfig {
  id              String          @id @default(cuid())
  companyId       String
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  alertType       AlertType
  enabled         Boolean         @default(true)
  severity        AlertSeverity   @default(WARNING)
  reminderDays    Int             @default(30)  // Days before to trigger reminder
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([companyId, alertType])
  @@index([companyId])
}

// =====================================================
// BNQ v3.0 - EXIGENCES DÉTAILLÉES (REQUIREMENTS)
// =====================================================

// Static reference table for BNQ requirements
model BnqRequirement {
  id                  String              @id @default(cuid())
  chapter             Int                 // 5, 6, 7, 8, or 9
  section             String              // e.g., "5.1", "7.4.5.e"
  title               String
  description         String
  requirement         String              // Full requirement text
  requiredForLevel    BnqLevel            @default(ES)
  isOptional          Boolean             @default(false)
  category            String?             // Grouping category
  linkedDocumentCode  String?             // Link to DocumentType.code
  linkedWorkflowStep  String?             // Link to WorkflowStep.stepCode
  verificationMethod  String?             // How to verify compliance
  evidence            String?             // What evidence is needed
  frequency           String?             // Verification frequency
  sortOrder           Int                 @default(0)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@unique([chapter, section])
  @@index([chapter])
}

// =====================================================
// SURVEY MODULE (Method B - Micro approach)
// =====================================================

enum SurveyStatus {
  DRAFT
  ACTIVE
  CLOSED
  ARCHIVED
}

model Survey {
  id                  String              @id @default(cuid())
  companyId           String
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  type                String              @default("PRESENTEEISM_V1")
  title               String              @default("Enquête Présentéisme")
  description         String?
  status              SurveyStatus        @default(DRAFT)
  surveyToken         String              @unique @default(cuid())  // Public token for anonymous access
  startDate           DateTime?
  endDate             DateTime?
  closedAt            DateTime?
  responses           SurveyResponse[]
  aggregate           SurveyAggregate?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([companyId])
  @@index([surveyToken])
}

// Anonymous survey response (no user identification)
model SurveyResponse {
  id                  String              @id @default(cuid())
  surveyId            String
  survey              Survey              @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  // Q1: Prevalence - worked while efficiency reduced
  q1Prevalence        String              // "NEVER" | "OCCASIONALLY" | "REGULARLY" | "VERY_FREQUENTLY"
  // Q2: Perceived efficiency (100%, 90%, 80%, 70%, 60%, 50% or less)
  q2EfficiencyPercent Int                 // 100, 90, 80, 70, 60, 50
  // Q3: Factors (multiple choice, stored as JSON array)
  q3Factors           String?             // JSON array: ["FATIGUE", "STRESS", "PAIN", "CONCENTRATION", "OTHER"]
  q3OtherText         String?             // Free text if "OTHER" selected
  // Q4: Impact (multiple choice, stored as JSON array)
  q4Impact            String?             // JSON array: ["QUALITY", "DELAYS", "COLLEAGUES", "ERRORS"]
  // Q5: Working hours per week
  q5WorkingHours      String              // "<35" | "35-39" | "40-44" | "45-49" | ">=50"
  // Metadata
  submittedAt         DateTime            @default(now())
  userAgent           String?             // Browser info for fraud detection (anonymous)

  @@index([surveyId])
}

// Aggregated survey results (calculated after survey closes)
model SurveyAggregate {
  id                      String          @id @default(cuid())
  surveyId                String          @unique
  survey                  Survey          @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  // Core metrics for Method B calculation
  respondentsCount        Int             @default(0)
  prevalence              Float           @default(0)  // % of respondents affected (not "NEVER")
  avgEfficiencyScore      Float           @default(1)  // Average efficiency among affected (0-1)
  // Quality indicators
  responseRate            Float?          // If company provides expected respondent count
  qualityFlag             String          @default("LOW")  // "LOW" | "MEDIUM" | "HIGH"
  // Factor distribution (stored as JSON)
  factorDistribution      String?         // JSON: { "FATIGUE": 45, "STRESS": 62, ... }
  impactDistribution      String?         // JSON: { "QUALITY": 34, "DELAYS": 28, ... }
  // Working hours distribution
  workingHoursDistribution String?        // JSON: { "<35": 5, "35-39": 40, ... }
  // Calculated Method B results
  presCostB               Float?          // Presenteeism cost (€/year)
  presCostBPct            Float?          // As % of payroll
  presCostBPerEmployee    Float?          // Per employee cost
  // Timestamps
  calculatedAt            DateTime?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
}

// =====================================================
// v4.0 - ACTIVITY LOG (AUDIT TRAIL)
// =====================================================

// Activity type for categorization
enum ActivityType {
  // User actions
  USER_LOGIN
  USER_LOGOUT
  USER_CREATED
  USER_UPDATED
  // Mission/Company actions
  MISSION_CREATED
  MISSION_UPDATED
  MISSION_DELETED
  // Survey actions
  SURVEY_CREATED
  SURVEY_LAUNCHED
  SURVEY_CLOSED
  SURVEY_THRESHOLD_REACHED
  // BNQ actions
  DOCUMENT_UPLOADED
  DOCUMENT_APPROVED
  DOCUMENT_EXPIRED
  WORKFLOW_STEP_COMPLETED
  WORKFLOW_TASK_COMPLETED
  // Action plan
  ACTION_PLAN_CREATED
  ACTION_PLAN_APPROVED
  INTERVENTION_CREATED
  INTERVENTION_COMPLETED
  INTERVENTION_OVERDUE
  // Alerts
  ALERT_CREATED
  ALERT_RESOLVED
  // Settings
  SETTINGS_UPDATED
  COEFFICIENT_UPDATED
  // System
  SYSTEM_NOTIFICATION
  CUSTOM
}

// Activity log for audit trail
model ActivityLog {
  id                  String              @id @default(cuid())
  // Who performed the action
  userId              String?
  user                User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail           String?             // Stored separately for historical reference
  userName            String?             // Stored separately for historical reference
  userRole            String?             // Role at time of action
  // What was done
  type                ActivityType
  action              String              // Human-readable action description
  description         String?             // Additional details
  // Context
  companyId           String?             // Related mission/company
  companyName         String?             // Stored for historical reference
  entityType          String?             // "Survey", "Document", "Intervention", etc.
  entityId            String?             // ID of the related entity
  entityName          String?             // Name of the related entity
  // Metadata
  metadata            String?             // JSON for additional data
  ipAddress           String?             // For security audit
  userAgent           String?             // Browser/device info
  // Timestamp
  createdAt           DateTime            @default(now())

  @@index([companyId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}


// =====================================================
// v4.1 - SURVEY ENGINE (JSON-DRIVEN SURVEYS)
// =====================================================

enum SurveyTypeCategory {
  PRESENTEEISM     // Diagnostic présentéisme
  QVCT             // Qualité de Vie et Conditions de Travail
  RPS              // Risques Psycho-Sociaux
  CLIMATE          // Climat social
  CUSTOM           // Type personnalisé
}

enum CampaignStatus {
  DRAFT            // Brouillon, pas encore lancée
  SCHEDULED        // Planifiée, date de lancement future
  ACTIVE           // En cours de collecte
  CLOSED           // Clôturée, calculs en cours
  COMPLETED        // Terminée, résultats disponibles
  ARCHIVED         // Archivée
}

// Types d'enquêtes (définitions JSON réutilisables)
model SurveyType {
  id                  String              @id @default(cuid())
  typeId              String              @unique  // "PRESENTEEISM_DIAGNOSTIC", "RADAR_QVCT_FLASH"
  name                String              // "Diagnostic Présentéisme & Coûts Cachés"
  description         String?
  version             String              @default("1.0")
  category            SurveyTypeCategory
  definition          Json                // Structure complète JSON du questionnaire
  isActive            Boolean             @default(true)
  isSystem            Boolean             @default(false)  // Types système non modifiables
  estimatedDuration   Int                 @default(10)     // Minutes
  anonymityThreshold  Int                 @default(15)     // Seuil d'anonymat
  dataRetentionDays   Int                 @default(730)    // 2 ans par défaut
  createdById         String?
  campaigns           SurveyCampaign[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([category])
  @@index([isActive])
}

// Campagnes d'enquête (instances lancées)
model SurveyCampaign {
  id                  String              @id @default(cuid())
  companyId           String
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  surveyTypeId        String
  surveyType          SurveyType          @relation(fields: [surveyTypeId], references: [id])
  name                String              // "Diagnostic Q1 2026"
  status              CampaignStatus      @default(DRAFT)
  token               String              @unique @default(cuid())  // Token public pour accès anonyme
  // Configuration
  targetPopulation    Int?                // Nombre de personnes ciblées
  minRespondents      Int                 @default(15)  // Minimum requis
  maxRespondents      Int?                // Maximum (null = illimité)
  // Dates
  scheduledStartDate  DateTime?
  scheduledEndDate    DateTime?
  launchedAt          DateTime?
  closedAt            DateTime?
  // Créateur
  createdById         String
  // Relations
  responses           CampaignResponse[]
  result              CampaignResult?
  deliverables        CampaignDeliverable[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([companyId])
  @@index([status])
  @@index([token])
  @@index([createdById])
}

// Réponses individuelles (anonymisées)
model CampaignResponse {
  id                  String              @id @default(cuid())
  campaignId          String
  campaign            SurveyCampaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  respondentHash      String              // Hash anonyme pour éviter doublons
  responses           Json                // { "Q1": 7, "Q2": ["A", "C"], "Q3": "Texte libre" }
  metadata            Json?               // Données démographiques agrégées optionnelles
  submittedAt         DateTime            @default(now())
  isComplete          Boolean             @default(true)
  userAgent           String?             // Pour détection fraude

  @@unique([campaignId, respondentHash])
  @@index([campaignId])
}

// Résultats calculés par campagne
model CampaignResult {
  id                  String              @id @default(cuid())
  campaignId          String              @unique
  campaign            SurveyCampaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  responseCount       Int                 @default(0)
  participationRate   Float?              // % de participation
  scores              Json                // { "GESTION": 6.5, "CONCILIATION": 7.2 }
  criticalIndicators  Json?               // { "high_presenteeism": { triggered: true, severity: "high" } }
  financialMetrics    Json?               // { "hidden_cost": 125000, "roi_estimate": 87500 }
  qualitativeInsights Json?               // Verbatims, ranking agrégés
  narrative           String?             // Texte narratif généré
  calculatedAt        DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

// Livrables générés (PDF)
model CampaignDeliverable {
  id                  String              @id @default(cuid())
  campaignId          String
  campaign            SurveyCampaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  type                String              // "executive_report", "radar_chart", "action_roadmap"
  title               String
  cloudStoragePath    String?             // S3 key
  fileFormat          String              @default("pdf")
  generatedAt         DateTime            @default(now())

  @@index([campaignId])
}